name: HQ Command Handler

on:
  issue_comment:
    types: [created]

jobs:
  hq:
    if: contains(github.event.comment.body, 'ë¶„ì„') || contains(github.event.comment.body, 'ìƒíƒœ')
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Ensure execute permission
        run: chmod +x scripts/handle_command.sh

      - name: Run HQ Command Handler (capture logs)
        id: run_hq
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # í‘œì¤€ì¶œë ¥/ì—ëŸ¬ ëª¨ë‘ ë¡œê·¸íŒŒì¼ ê¸°ë¡
          ./scripts/handle_command.sh > tmp.log 2>&1 || echo "failed" > .hq_failed

      - name: Report Success (append)
        if: success() && steps.run_hq.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.comment.id }}
          REPO: ${{ github.repository }}
        run: |
          BODY="\n(Workflow Status: success)"
          curl -s -X PATCH \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${REPO}/issues/comments/${COMMENT_ID}" \
            -d "{\"body\": \"$(echo -e ${BODY})\"}"

      - name: Report Failure (new comment)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          TRIGGER_URL: https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}#issuecomment-${{ github.event.comment.id }}
          WF_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "âš ï¸ Command Failed" > err.log
          echo "" >> err.log
          echo "ðŸ§­ Workflow â–¶ ${WF_URL}" >> err.log
          echo "ðŸ“Œ Trigger â–¶ ${TRIGGER_URL}" >> err.log
          echo "" >> err.log
          echo "â”€â”€â”€â”€â”€ LOGS â”€â”€â”€â”€â”€" >> err.log
          cat tmp.log >> err.log || true

          # JSON escape
          esc_body=$(sed 's/"/\\"/g' err.log)

          curl -s -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${REPO}/issues/${ISSUE_NUM}/comments" \
            -d "{\"body\": \"${esc_body}\"}"

            
